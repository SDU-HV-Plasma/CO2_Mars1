function [ BB,GG,Y,Bsim,Gsim ] = CO2m5z_matrix( X,nsp,number_of_reactions,Ralldlt,sim,Vibration,n,number_of_reaction )

global BB GG Bsim Gsim

i=1;
while i<nsp+1
    for j=1:nsp
        BB{i,j}=intersect(find(X(i,1:number_of_reactions)>0),find(X(j,1:number_of_reactions)<0));
    end
    i=i+1;
end

load Bmatrix.mat
load Gmatrix.mat

for i=1:length(B)
    for j=1:length(B)
        B{i,j}(B{i,j}>73)=B{i,j}(B{i,j}>73)+105;
        G{i,j}(G{i,j}>73)=G{i,j}(G{i,j}>73)+105;
    end
end

for i=1:18
    for j=1:18
        BB{i,j}=union(B{i,j},BB{i,j});
        BB{i+34,j}=union(B{i+18,j},BB{i+34,j});
        BB{i,j+34}=union(B{i,j+18},BB{i,j+34});
        BB{i+34,j+34}=union(B{i+18,i+18},BB{i+34,j+34});
    end
end

BB{4,1}=[102,103,104,105,BB{4,1}];
BB{22,1}=[105,BB{22,1}];
BB{23,1}=[104,BB{23,1}];
BB{26,1}=[96,103,BB{27,1}];
BB{28,1}=[95,BB{28,1}];
BB{29,1}=[98,102,BB{29,1}];
BB{30,1}=[100,BB{30,1}];
BB{31,1}=[101,BB{31,1}];
BB{1,2}=[177,BB{1,2}];
BB{21,2}=[77,882:899,BB{21,2}];
BB{23,2}=[177,BB{23,2}];
BB{1,10}=[178,BB{1,10}];
BB{2,10}=[83,BB{2,10}];
BB{8,10}=[90,BB{12,10}];
BB{14,10}=[83,BB{14,10}];
BB{19,10}=[80,BB{19,10}];
BB{20,10}=[81,BB{20,10}];
BB{23,10}=[178,BB{23,10}];
BB{25,10}=[176,BB{25,10}];
BB{33,10}=[107,BB{33,10}];
BB{1,22}=[116,BB{1,22}];
BB{23,22}=[116,BB{23,22}];
BB{33,22}=[106,151,BB{33,22}];
BB{1,35}=[1026,BB{1,35}];
BB{2,35}=[936,BB{2,35}];
BB{8,35}=[954,BB{8,35}];
BB{10,35}=[900,918,954,BB{10,35}];
BB{14,35}=[936,BB{14,35}];
BB{19,35}=[900,BB{19,35}];
BB{20,35}=[918,BB{20,35}];
BB{23,35}=[1026,BB{23,35}];
BB{25,35}=[1008,BB{25,35}];
BB{1,36}=[1027,BB{1,36}];
BB{2,36}=[937,BB{2,36}];
BB{8,36}=[955,BB{8,36}];
BB{10,36}=[901,919,955,BB{10,36}];
BB{14,36}=[937,BB{14,36}];
BB{19,36}=[901,BB{19,36}];
BB{20,36}=[919,BB{20,36}];
BB{23,36}=[1027,BB{23,36}];
BB{25,36}=[1009,BB{25,36}];
BB{1,37}=[1028,BB{1,37}];
BB{2,37}=[938,BB{2,37}];
BB{8,37}=[956,BB{8,37}];
BB{10,37}=[902,920,956,BB{10,37}];
BB{14,37}=[938,BB{14,37}];
BB{19,37}=[902,BB{19,37}];
BB{20,37}=[920,BB{20,37}];
BB{23,37}=[1028,BB{23,37}];
BB{25,37}=[1010,BB{25,37}];
BB{1,38}=[1029,BB{1,38}];
BB{2,38}=[939,BB{2,38}];
BB{8,38}=[957,BB{8,38}];
BB{10,38}=[903,921,957,BB{10,38}];
BB{14,38}=[939,BB{14,38}];
BB{19,38}=[903,BB{19,38}];
BB{20,38}=[921,BB{20,38}];
BB{23,38}=[1029,BB{23,38}];
BB{25,38}=[1011,BB{25,38}];
BB{1,39}=[1030,BB{1,39}];
BB{2,39}=[940,BB{2,39}];
BB{8,39}=[958,BB{8,39}];
BB{10,39}=[904,922,958,BB{10,39}];
BB{14,39}=[940,BB{14,39}];
BB{19,39}=[904,BB{19,39}];
BB{20,39}=[922,BB{20,39}];
BB{23,39}=[1030,BB{23,39}];
BB{25,39}=[1012,BB{25,39}];
BB{1,40}=[1031,BB{1,40}];
BB{2,40}=[941,BB{2,40}];
BB{8,40}=[959,BB{8,40}];
BB{10,40}=[905,923,959,BB{10,40}];
BB{14,40}=[941,BB{14,40}];
BB{19,40}=[905,BB{19,40}];
BB{20,40}=[923,BB{20,40}];
BB{23,40}=[1031,BB{23,40}];
BB{25,40}=[1013,BB{25,40}];
BB{1,41}=[1032,BB{1,41}];
BB{2,41}=[942,BB{2,41}];
BB{8,41}=[960,BB{8,41}];
BB{10,41}=[906,924,960,BB{10,41}];
BB{14,41}=[942,BB{14,41}];
BB{19,41}=[906,BB{19,41}];
BB{20,41}=[924,BB{20,41}];
BB{23,41}=[1032,BB{23,41}];
BB{25,41}=[1014,BB{25,41}];
BB{1,42}=[1033,BB{1,42}];
BB{2,42}=[943,BB{2,42}];
BB{8,42}=[961,BB{8,42}];
BB{10,42}=[907,925,961,BB{10,42}];
BB{14,42}=[943,BB{14,42}];
BB{19,42}=[907,BB{19,42}];
BB{20,42}=[925,BB{20,42}];
BB{23,42}=[1033,BB{23,42}];
BB{25,42}=[1015,BB{25,42}];
BB{1,43}=[1034,BB{1,43}];
BB{2,43}=[944,BB{2,43}];
BB{8,43}=[962,BB{8,43}];
BB{10,43}=[908,926,962,BB{10,43}];
BB{14,43}=[944,BB{14,43}];
BB{19,43}=[908,BB{19,43}];
BB{20,43}=[926,BB{20,43}];
BB{23,43}=[1034,BB{23,43}];
BB{25,43}=[1016,BB{25,43}];
BB{1,44}=[1035,BB{1,44}];
BB{2,44}=[945,BB{2,44}];
BB{8,44}=[963,BB{8,44}];
BB{10,44}=[909,927,963,BB{10,44}];
BB{14,44}=[945,BB{14,44}];
BB{19,44}=[909,BB{19,44}];
BB{20,44}=[927,BB{20,44}];
BB{23,44}=[1035,BB{23,44}];
BB{25,44}=[1017,BB{25,44}];
BB{1,45}=[1036,BB{1,45}];
BB{2,45}=[946,BB{2,45}];
BB{8,45}=[964,BB{8,45}];
BB{10,45}=[910,928,964,BB{10,45}];
BB{14,45}=[946,BB{14,45}];
BB{19,45}=[910,BB{19,45}];
BB{20,45}=[928,BB{20,45}];
BB{23,45}=[1036,BB{23,45}];
BB{25,45}=[1018,BB{25,45}];
BB{1,46}=[1037,BB{1,46}];
BB{2,46}=[947,BB{2,46}];
BB{8,46}=[965,BB{8,46}];
BB{10,46}=[911,929,965,BB{10,46}];
BB{14,46}=[947,BB{14,46}];
BB{19,46}=[911,BB{19,46}];
BB{20,46}=[929,BB{20,46}];
BB{23,46}=[1037,BB{23,46}];
BB{25,46}=[1019,BB{25,46}];
BB{1,47}=[1038,BB{1,47}];
BB{2,47}=[948,BB{2,47}];
BB{8,47}=[966,BB{8,47}];
BB{10,47}=[912,930,966,BB{10,47}];
BB{14,47}=[948,BB{14,47}];
BB{19,47}=[912,BB{19,47}];
BB{20,47}=[930,BB{20,47}];
BB{23,47}=[1038,BB{23,47}];
BB{25,47}=[1020,BB{25,47}];
BB{1,48}=[1039,BB{1,48}];
BB{2,48}=[949,BB{2,48}];
BB{8,48}=[967,BB{8,48}];
BB{10,48}=[913,931,967,BB{10,48}];
BB{14,48}=[949,BB{14,48}];
BB{19,48}=[913,BB{19,48}];
BB{20,48}=[931,BB{20,48}];
BB{23,48}=[1039,BB{23,48}];
BB{25,48}=[1021,BB{25,48}];
BB{1,49}=[1040,BB{1,49}];
BB{2,49}=[950,BB{2,49}];
BB{8,49}=[968,BB{8,49}];
BB{10,49}=[914,932,968,BB{10,49}];
BB{14,49}=[950,BB{14,49}];
BB{19,49}=[914,BB{19,49}];
BB{20,49}=[932,BB{20,49}];
BB{23,49}=[1040,BB{23,49}];
BB{25,49}=[1022,BB{25,49}];
BB{1,50}=[1041,BB{1,50}];
BB{2,50}=[951,BB{2,50}];
BB{8,50}=[969,BB{8,50}];
BB{10,50}=[915,933,969,BB{10,50}];
BB{14,50}=[951,BB{14,50}];
BB{19,50}=[915,BB{19,50}];
BB{20,50}=[933,BB{20,50}];
BB{23,50}=[1041,BB{23,50}];
BB{25,50}=[1023,BB{25,50}];
BB{1,51}=[1042,BB{1,51}];
BB{2,51}=[952,BB{2,51}];
BB{8,51}=[970,BB{8,51}];
BB{10,51}=[916,934,970,BB{10,51}];
BB{14,51}=[952,BB{14,51}];
BB{19,51}=[916,BB{19,51}];
BB{20,51}=[934,BB{20,51}];
BB{23,51}=[1042,BB{23,51}];
BB{25,51}=[1024,BB{25,51}];
BB{1,52}=[1043,BB{1,52}];
BB{2,52}=[953,BB{2,52}];
BB{8,52}=[971,BB{8,52}];
BB{10,52}=[917,935,971,BB{10,52}];
BB{14,52}=[953,BB{14,52}];
BB{19,52}=[917,BB{19,52}];
BB{20,52}=[935,BB{20,52}];
BB{23,52}=[1043,BB{23,52}];
BB{25,52}=[1025,BB{25,52}];

GG=BB;

for i=1:18
    for j=1:18
        GG{i,j}=union(G{i,j},GG{i,j});
        GG{i+34,j}=union(G{i+18,j},GG{i+34,j});
        GG{i,j+34}=union(G{i,j+18},GG{i,j+34});
        GG{i+34,j+34}=union(G{i+18,i+18},GG{i+34,j+34});
    end
end
% GG(1:18,1:18)=G(1:18,1:18);
% GG(35:52,1:18)=G(19:36,1:18);
% GG(1:18,35:52)=G(1:18,19:36);
% GG(35:52,35:52)=G(19:36,19:36);

GG{10,1}=[107,GG{10,1}];
GG{22,1}=[106,GG{22,1}];
GG{35,2}=[900,918,GG{35,2}];
GG{36,2}=[901,919,GG{36,2}];
GG{37,2}=[902,920,GG{37,2}];
GG{38,2}=[903,921,GG{38,2}];
GG{39,2}=[904,922,GG{39,2}];
GG{40,2}=[905,923,GG{40,2}];
GG{41,2}=[906,924,GG{41,2}];
GG{42,2}=[907,925,GG{42,2}];
GG{43,2}=[908,926,GG{43,2}];
GG{44,2}=[909,927,GG{44,2}];
GG{45,2}=[910,928,GG{45,2}];
GG{46,2}=[911,929,GG{46,2}];
GG{47,2}=[912,930,GG{47,2}];
GG{48,2}=[913,931,GG{48,2}];
GG{49,2}=[914,932,GG{49,2}];
GG{50,2}=[915,933,GG{50,2}];
GG{51,2}=[916,934,GG{51,2}];
GG{52,2}=[917,935,GG{52,2}];
GG{10,4}=[176,GG{10,4}];
GG{35,4}=[1008,GG{35,4}];
GG{36,4}=[1009,GG{36,4}];
GG{37,4}=[1010,GG{37,4}];
GG{38,4}=[1011,GG{38,4}];
GG{39,4}=[1012,GG{39,4}];
GG{40,4}=[1013,GG{40,4}];
GG{41,4}=[1014,GG{41,4}];
GG{42,4}=[1015,GG{42,4}];
GG{43,4}=[1016,GG{43,4}];
GG{44,4}=[1017,GG{44,4}];
GG{45,4}=[1018,GG{45,4}];
GG{46,4}=[1019,GG{46,4}];
GG{47,4}=[1020,GG{47,4}];
GG{48,4}=[1021,GG{48,4}];
GG{49,4}=[1022,GG{49,4}];
GG{50,4}=[1023,GG{50,4}];
GG{51,4}=[1024,GG{51,4}];
GG{52,4}=[1025,GG{52,4}];
GG{22,6}=[151,GG{22,6}];
GG{2,8}=[77,882:899,GG{2,8}];
GG{2,10}=[77,GG{2,10}];
GG{10,19}=[83,GG{10,19}];
GG{35,19}=[936,GG{35,19}];
GG{36,19}=[937,GG{36,19}];
GG{37,19}=[938,GG{37,19}];
GG{38,19}=[939,GG{38,19}];
GG{39,19}=[940,GG{39,19}];
GG{40,19}=[941,GG{40,19}];
GG{41,19}=[942,GG{41,19}];
GG{42,19}=[943,GG{42,19}];
GG{43,19}=[944,GG{43,19}];
GG{44,19}=[945,GG{44,19}];
GG{45,19}=[946,GG{45,19}];
GG{46,19}=[947,GG{46,19}];
GG{47,19}=[948,GG{47,19}];
GG{48,19}=[949,GG{48,19}];
GG{49,19}=[950,GG{49,19}];
GG{50,19}=[951,GG{50,19}];
GG{51,19}=[952,GG{51,19}];
GG{52,19}=[953,GG{52,19}];
GG{35,20}=[900,GG{35,20}];
GG{36,20}=[901,GG{36,20}];
GG{37,20}=[902,GG{37,20}];
GG{38,20}=[903,GG{38,20}];
GG{39,20}=[904,GG{39,20}];
GG{40,20}=[905,GG{40,20}];
GG{41,20}=[906,GG{41,20}];
GG{42,20}=[907,GG{42,20}];
GG{43,20}=[908,GG{43,20}];
GG{44,20}=[909,GG{44,20}];
GG{45,20}=[910,GG{45,20}];
GG{46,20}=[911,GG{46,20}];
GG{47,20}=[912,GG{47,20}];
GG{48,20}=[913,GG{48,20}];
GG{49,20}=[914,GG{49,20}];
GG{50,20}=[915,GG{50,20}];
GG{51,20}=[916,GG{51,20}];
GG{52,20}=[917,GG{52,20}];
GG{35,21}=[918,954,GG{35,21}];
GG{36,21}=[919,955,GG{36,21}];
GG{37,21}=[920,956,GG{37,21}];
GG{38,21}=[921,957,GG{38,21}];
GG{39,21}=[922,958,GG{39,21}];
GG{40,21}=[923,959,GG{40,21}];
GG{41,21}=[924,960,GG{41,21}];
GG{42,21}=[925,961,GG{42,21}];
GG{43,21}=[926,962,GG{43,21}];
GG{44,21}=[927,963,GG{44,21}];
GG{45,21}=[928,964,GG{45,21}];
GG{46,21}=[929,965,GG{46,21}];
GG{47,21}=[930,966,GG{47,21}];
GG{48,21}=[931,967,GG{48,21}];
GG{49,21}=[932,968,GG{49,21}];
GG{50,21}=[933,969,GG{50,21}];
GG{51,21}=[934,970,GG{51,21}];
GG{52,21}=[935,971,GG{52,21}];
GG{1,22}=[96,GG{1,22}];
GG{1,23}=[103,GG{1,23}];
GG{10,23}=[176,GG{10,23}];
GG{22,23}=[151,GG{22,23}];
GG{35,23}=[1008,GG{35,23}];
GG{36,23}=[1009,GG{36,23}];
GG{37,23}=[1010,GG{37,23}];
GG{38,23}=[1011,GG{38,23}];
GG{39,23}=[1012,GG{39,23}];
GG{40,23}=[1013,GG{40,23}];
GG{41,23}=[1014,GG{41,23}];
GG{42,23}=[1015,GG{42,23}];
GG{43,23}=[1016,GG{43,23}];
GG{44,23}=[1017,GG{44,23}];
GG{45,23}=[1018,GG{45,23}];
GG{46,23}=[1019,GG{46,23}];
GG{47,23}=[1020,GG{47,23}];
GG{48,23}=[1021,GG{48,23}];
GG{49,23}=[1022,GG{49,23}];
GG{50,23}=[1023,GG{50,23}];
GG{51,23}=[1024,GG{51,23}];
GG{52,23}=[1025,GG{52,23}];
GG{1,24}=[105,GG{1,24}];
GG{1,25}=[104,GG{1,25}];
GG{10,25}=[107,GG{10,25}];
GG{22,25}=[106,GG{22,25}];
GG{2,32}=[177,GG{2,32}];
GG{10,32}=[178,GG{10,32}];
GG{22,32}=[116,GG{22,32}];
GG{35,32}=[1026,GG{35,32}];
GG{36,32}=[1027,GG{36,32}];
GG{37,32}=[1028,GG{37,32}];
GG{38,32}=[1029,GG{38,32}];
GG{39,32}=[1030,GG{39,32}];
GG{40,32}=[1031,GG{40,32}];
GG{41,32}=[1032,GG{41,32}];
GG{42,32}=[1033,GG{42,32}];
GG{43,32}=[1034,GG{43,32}];
GG{44,32}=[1035,GG{44,32}];
GG{45,32}=[1036,GG{45,32}];
GG{46,32}=[1037,GG{46,32}];
GG{47,32}=[1038,GG{47,32}];
GG{48,32}=[1039,GG{48,32}];
GG{49,32}=[1040,GG{49,32}];
GG{50,32}=[1041,GG{50,32}];
GG{51,32}=[1042,GG{51,32}];
GG{52,32}=[1043,GG{52,32}];
GG{2,35}=[882,G{2,35}];
GG{2,36}=[883,GG{2,36}];
GG{2,37}=[884,GG{2,37}];
GG{2,38}=[885,GG{2,38}];
GG{2,39}=[886,GG{2,39}];
GG{2,40}=[887,GG{2,40}];
GG{2,41}=[888,GG{2,41}];
GG{2,42}=[889,GG{2,42}];
GG{2,43}=[890,GG{2,43}];
GG{2,44}=[891,GG{2,44}];
GG{2,45}=[892,GG{2,45}];
GG{2,46}=[893,GG{2,46}];
GG{2,47}=[894,GG{2,47}];
GG{2,48}=[895,GG{2,48}];
GG{2,49}=[896,GG{2,49}];
GG{2,50}=[897,GG{2,50}];
GG{2,51}=[898,GG{2,51}];
GG{2,52}=[899,GG{2,52}];

for i=1:nsp
    for j=1:nsp            
        BB{i,j}=setdiff(BB{i,j},Ralldlt);
        GG{i,j}=setdiff(GG{i,j},Ralldlt);
    end
end

if Vibration~=1
    for i=1:nsp
        for j=1:nsp
            if i>length(n)+1 || j>length(n)+1
                BB{i,j}=[];
                GG{i,j}=[];
            end
        end
    end
%     BB(length(n)+1:nsp,:)=[];
%     BB(:,length(n)+1:nsp)=[];
%     GG(length(n)+1:nsp,:)=[];
%     GG(:,length(n)+1:nsp)=[];
    for i=1:length(n)
        for j=1:length(n)
            BB{i,j}(BB{i,j}>number_of_reaction)=[];
            GG{i,j}(GG{i,j}>number_of_reaction)=[];
        end
    end
end

% 建立有向矩阵
i=1;
while i<nsp+1
    for j=1:nsp
        Y1(i,j)=sum(X(i,BB{i,j}));
    end
    Y2(i)=sum(X(i,X(i,:)>0));
    i=i+1;
end
Y=Y1./Y2';

Bsim=BB;Gsim=GG;

if sim==1
    Bsim(find(all(cellfun(@(x) isempty(x),Bsim),2)),:)=[];
    Bsim(:,find(all(cellfun(@(x) isempty(x),Bsim))))=[];
    Gsim(find(all(cellfun(@(x) isempty(x),Gsim),2)),:)=[];
    Gsim(:,find(all(cellfun(@(x) isempty(x),Gsim))))=[];
%     Y(find(all(cellfun(@(x) isnan(x),Y),2)),:)=[];
%     Y(:,find(all(cellfun(@(x) isempty(x),Y))))=[];
end

end

